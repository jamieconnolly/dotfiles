#!/bin/bash
# Usage: script/setup
# Summary: Set up the dotfiles

set -e
cd "$(git rev-parse --show-toplevel)"

DOTFILES_ROOT="$(pwd -P)"

# Link dotfiles into the home directory

echo "==> Linking dotfiles into the home directory…"
for SRC_PATH in ${DOTFILES_ROOT}/*; do
  [[ "$SRC_PATH" == **/Library ]] && continue
  [[ "$SRC_PATH" == **/script ]] && continue
  [[ "$SRC_PATH" == **/*.md ]] && continue
  [[ "$SRC_PATH" == **/*.txt ]] && continue

  DEST_PATH="${HOME}/.${SRC_PATH##${DOTFILES_ROOT}/}"
  if [[ ! -e "$DEST_PATH" ]] || [[ "$(readlink "$DEST_PATH")" != "$SRC_PATH" ]]; then
    if [[ -L "$DEST_PATH" ]] && [[ ! -d "$SRC_PATH" ]]; then
      ln -sfv "$SRC_PATH" "$DEST_PATH"
    else
      rm -rf "$DEST_PATH"
      ln -sv "$SRC_PATH" "$DEST_PATH"
    fi
  fi
done

# Link config files into the user library

echo "==> Linking config files into the user library…"
for SRC_PATH in ${DOTFILES_ROOT}/Library/**/*; do
  DEST_PATH="${HOME}/${SRC_PATH##${DOTFILES_ROOT}/}"
  if [[ ! -e "$DEST_PATH" ]] || [[ "$(readlink "$DEST_PATH")" != "$SRC_PATH" ]]; then
    if [[ -L "$DEST_PATH" ]] && [[ ! -d "$SRC_PATH" ]]; then
      ln -sfv "$SRC_PATH" "$DEST_PATH"
    else
      rm -rf "$DEST_PATH"
      ln -sv "$SRC_PATH" "$DEST_PATH"
    fi
  fi
done

# Install Homebrew dependencies

echo "==> Installing Homebrew dependencies…"
if [ -z "$TRAVIS" ]; then
  brew bundle check --global &>/dev/null || {
    brew bundle --global
  }
else
  echo "Skipping Homebrew dependencies for CI"
fi

# Install Atom packages

if command -v apm >/dev/null 2>&1; then
  echo "==> Installing Atom packages…"
  while IFS=" " read -r -a line; do
    [ "${#line[@]}" -gt 0 ] || continue
    [ "${line[0]:0:1}" != "#" ] || continue

    pkg_name="${line[0]}"
    if [ ! -d "${HOME}/.atom/packages/${pkg_name}" ]; then
      apm install "$pkg_name"
    fi
  done < "${DOTFILES_ROOT}/atom/default-packages"
fi

# Change the login shell to zsh

if command -v zsh >/dev/null 2>&1; then
  ZSH_PATH=$(command -v zsh)

  if [ "$(dscl . -read "$HOME" UserShell 2>/dev/null | cut -d" " -f2)" != "$ZSH_PATH" ]; then
    echo "==> Changing the login shell to zsh…"

    if ! grep "$ZSH_PATH" /etc/shells >/dev/null 2>&1; then
      echo "$ZSH_PATH" | sudo tee -a /etc/shells >/dev/null
    fi

    sudo chsh -s "$ZSH_PATH" "$(whoami)"
  fi
fi
