#!/bin/bash
# Usage: script/setup
# Summary: Install the dotfiles into the home directory

set -e
cd "$(git rev-parse --show-toplevel)"

DOTFILES_ROOT=$(pwd -P)

# Install dotfiles

echo "==> Installing dotfiles…"
for DOTFILE in ${DOTFILES_ROOT}/*; do
  [[ "$DOTFILE" == **/script ]] && continue
  [[ "$DOTFILE" == **/*.md ]] && continue
  [[ "$DOTFILE" == **/*.txt ]] && continue

  HOMEFILE="${HOME}/.${DOTFILE##*/}"
  if [[ ! -e "$HOMEFILE" ]] || [[ $(ls -l "$HOMEFILE" | awk '{print $11}') != "$DOTFILE" ]]; then
    if [[ -L "$HOMEFILE" ]] && [[ ! -d "$DOTFILE" ]]; then
      ln -sfv "$DOTFILE" "$HOMEFILE"
    else
      rm -rf "$HOMEFILE"
      ln -sv "$DOTFILE" "$HOMEFILE"
    fi
  fi
done

# Install Atom packages

if command -v apm >/dev/null 2>&1; then
  echo "==> Installing Atom packages…"
  while IFS=" " read -r -a line; do
    [ "${#line[@]}" -gt 0 ] || continue
    [ "${line[0]:0:1}" != "#" ] || continue

    pkg_name="${line[0]}"
    if [ ! -d "${HOME}/.atom/packages/${pkg_name}" ]; then
      apm install "$pkg_name"
    fi
  done < "${DOTFILES_ROOT}/atom/default-packages"
fi
