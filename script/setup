#!/bin/bash
# Usage: script/setup
# Summary: Install the dotfiles into the home directory

set -e
cd "$(git rev-parse --show-toplevel)"

DOTFILES_ROOT="$(pwd -P)"

# Symlink dotfiles into the home directory

echo "==> Symlinking dotfiles into the home directory…"
for DOTFILE in ${DOTFILES_ROOT}/*; do
  [[ "$DOTFILE" == **/script ]] && continue
  [[ "$DOTFILE" == **/*.md ]] && continue
  [[ "$DOTFILE" == **/*.txt ]] && continue

  HOMEFILE="${HOME}/.${DOTFILE##*/}"
  if [[ ! -e "$HOMEFILE" ]] || [[ "$(readlink "$HOMEFILE")" != "$DOTFILE" ]]; then
    if [[ -L "$HOMEFILE" ]] && [[ ! -d "$DOTFILE" ]]; then
      ln -sfv "$DOTFILE" "$HOMEFILE"
    else
      rm -rf "$HOMEFILE"
      ln -sv "$DOTFILE" "$HOMEFILE"
    fi
  fi
done

# Install Homebrew dependencies

echo "==> Installing Homebrew dependencies…"
if [ -z "$TRAVIS" ]; then
  brew bundle check --global &>/dev/null || {
    brew bundle --global
  }
else
  echo "Skipping Homebrew dependencies for CI"
fi

# Install Atom packages

if command -v apm >/dev/null 2>&1; then
  echo "==> Installing Atom packages…"
  while IFS=" " read -r -a line; do
    [ "${#line[@]}" -gt 0 ] || continue
    [ "${line[0]:0:1}" != "#" ] || continue

    pkg_name="${line[0]}"
    if [ ! -d "${HOME}/.atom/packages/${pkg_name}" ]; then
      apm install "$pkg_name"
    fi
  done < "${DOTFILES_ROOT}/atom/default-packages"
fi

# Change the login shell to zsh

if command -v zsh >/dev/null 2>&1; then
  ZSH_PATH=$(command -v zsh)

  if [ "$(dscl . -read "$HOME" UserShell 2>/dev/null | cut -d" " -f2)" != "$ZSH_PATH" ]; then
    echo "==> Changing the login shell to zsh…"

    if ! grep "$ZSH_PATH" /etc/shells >/dev/null 2>&1; then
      echo "$ZSH_PATH" | sudo tee -a /etc/shells >/dev/null
    fi

    sudo chsh -s "$ZSH_PATH" "$(whoami)"
  fi
fi
